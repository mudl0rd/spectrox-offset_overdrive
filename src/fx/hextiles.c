#include "hextiles.h"

#include <GL/gl.h>
#include "../fw/image.h"
#include "../resource.h"

#define NUM_X 21
#define NUM_Y 22

// Export with FileToCArray with `Palette mod` option `8bit grayscale`.
static const unsigned char _delayTable[]  = {
    0x2c, 0x2c, 0x2c, 0x2c, 0x2c, 0x2c, 0x2d, 0x2d, 0x2e, 0x2e, 0x2e, 0x2f, 0x30, 0x30, 0x31, 0x32, 0x32, 0x33, 0x34, 0x35, 0x36,
    0x29, 0x29, 0x28, 0x28, 0x28, 0x29, 0x29, 0x2a, 0x2b, 0x2b, 0x2b, 0x2b, 0x2c, 0x2d, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33,
    0x28, 0x28, 0x26, 0x25, 0x24, 0x25, 0x25, 0x26, 0x29, 0x28, 0x27, 0x26, 0x25, 0x25, 0x28, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,
    0x23, 0x24, 0x24, 0x23, 0x21, 0x21, 0x21, 0x23, 0x26, 0x27, 0x26, 0x23, 0x21, 0x21, 0x21, 0x23, 0x28, 0x29, 0x2a, 0x2c, 0x2d,
    0x1e, 0x21, 0x22, 0x21, 0x20, 0x1e, 0x1d, 0x1e, 0x22, 0x25, 0x24, 0x23, 0x21, 0x20, 0x1e, 0x1f, 0x22, 0x26, 0x28, 0x29, 0x2a,
    0x18, 0x1a, 0x1d, 0x1d, 0x1d, 0x1c, 0x1a, 0x1b, 0x1e, 0x21, 0x22, 0x21, 0x1f, 0x1f, 0x1d, 0x1c, 0x20, 0x24, 0x25, 0x26, 0x27,
    0x14, 0x14, 0x15, 0x17, 0x18, 0x18, 0x16, 0x17, 0x1c, 0x1b, 0x1c, 0x1b, 0x1b, 0x1c, 0x1a, 0x19, 0x1d, 0x21, 0x22, 0x24, 0x25,
    0x10, 0x10, 0x10, 0x10, 0x11, 0x12, 0x12, 0x15, 0x19, 0x17, 0x16, 0x17, 0x18, 0x16, 0x15, 0x17, 0x1c, 0x1f, 0x20, 0x22, 0x23,
    0x0c, 0x0c, 0x0c, 0x0c, 0x0d, 0x0e, 0x0f, 0x11, 0x15, 0x13, 0x13, 0x15, 0x14, 0x13, 0x14, 0x18, 0x1c, 0x1d, 0x1e, 0x20, 0x21,
    0x08, 0x08, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0e, 0x0f, 0x10, 0x11, 0x11, 0x11, 0x12, 0x14, 0x18, 0x1a, 0x1c, 0x1d, 0x1f, 0x20,
    0x04, 0x04, 0x05, 0x06, 0x07, 0x08, 0x0a, 0x0b, 0x0d, 0x0e, 0x0e, 0x0f, 0x11, 0x14, 0x17, 0x18, 0x19, 0x1b, 0x1c, 0x1e, 0x1f,
    0x00, 0x01, 0x03, 0x04, 0x06, 0x07, 0x08, 0x09, 0x0b, 0x0d, 0x0f, 0x11, 0x14, 0x15, 0x16, 0x17, 0x19, 0x1a, 0x1c, 0x1e, 0x1f,
    0x04, 0x04, 0x05, 0x06, 0x07, 0x08, 0x0a, 0x0b, 0x0d, 0x0e, 0x10, 0x11, 0x12, 0x14, 0x16, 0x18, 0x19, 0x1b, 0x1c, 0x1f, 0x1f,
    0x08, 0x08, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0f, 0x10, 0x10, 0x11, 0x13, 0x16, 0x17, 0x19, 0x1a, 0x1c, 0x1d, 0x20, 0x20,
    0x0c, 0x0c, 0x0c, 0x0c, 0x0d, 0x0f, 0x10, 0x11, 0x12, 0x16, 0x14, 0x13, 0x15, 0x17, 0x19, 0x1a, 0x1c, 0x1d, 0x1e, 0x20, 0x21,
    0x10, 0x10, 0x10, 0x10, 0x12, 0x14, 0x15, 0x18, 0x16, 0x19, 0x18, 0x16, 0x16, 0x19, 0x1b, 0x1c, 0x1d, 0x1f, 0x21, 0x22, 0x23,
    0x14, 0x14, 0x14, 0x14, 0x16, 0x18, 0x19, 0x1b, 0x1a, 0x1c, 0x1c, 0x1a, 0x19, 0x19, 0x1d, 0x1e, 0x20, 0x21, 0x23, 0x24, 0x25,
    0x18, 0x18, 0x18, 0x19, 0x1a, 0x1b, 0x1a, 0x1f, 0x1d, 0x1e, 0x20, 0x1e, 0x1b, 0x1b, 0x1d, 0x1f, 0x21, 0x23, 0x25, 0x26, 0x27,
    0x1c, 0x1c, 0x1c, 0x1c, 0x1d, 0x1d, 0x1e, 0x21, 0x20, 0x21, 0x23, 0x23, 0x20, 0x1f, 0x21, 0x22, 0x23, 0x25, 0x27, 0x29, 0x2a,
    0x20, 0x1f, 0x20, 0x1f, 0x20, 0x21, 0x21, 0x23, 0x24, 0x24, 0x26, 0x26, 0x25, 0x25, 0x25, 0x24, 0x25, 0x27, 0x2a, 0x2c, 0x2d,
    0x24, 0x24, 0x23, 0x24, 0x24, 0x25, 0x25, 0x25, 0x26, 0x27, 0x27, 0x29, 0x28, 0x29, 0x2a, 0x29, 0x2a, 0x2d, 0x2e, 0x2f, 0x30,
    0x28, 0x28, 0x28, 0x28, 0x28, 0x29, 0x29, 0x29, 0x2a, 0x2a, 0x2b, 0x2b, 0x2c, 0x2d, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33
};

// Specify at what palette entry to stop color cycling.
// Export with FileToCArray with `Palette mod` option `8bit grayscale`.
static const unsigned char _maxPaletteTable[]  = {
    0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x11, 0x11, 0x12, 0x11, 0x12, 0x12, 0x12,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x11, 0x12, 0x12, 0x12, 0x12,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x12, 0x12,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x12, 0x12, 0x11, 0x12,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x12, 0x11, 0x12, 0x11, 0x11, 0x12, 0x12,
    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x11, 0x11, 0x12, 0x11, 0x12, 0x12, 0x12, 0x12
};

static const fw_vec3i _palette[] = {
    {70, 70, 70},
    {100, 100, 100},
    {140, 140, 140},
    {140, 155, 190},
    {138, 179, 199},
    {149, 213, 212},
    {188, 239, 205},
    {242, 240, 179},
    {237, 237, 237},
    {242, 240, 179},
    {188, 239, 205},
    {149, 213, 212},
    {138, 179, 199},
    {140, 155, 190},
    {140, 140, 140},
    {100, 100, 100},
    {70, 70, 70},
    {50, 50, 50},
    {28, 28, 28},
};
static const int _paletteLengh = LEN(_palette);


// Key: Coordinates as x + y*NUM_Y
// Val: 0=filled, 1=outline
static const unsigned char _hexStyleMap[] = {
    [4 + 0*NUM_X] = 1,
    [5 + 0*NUM_X] = 1,
    [11 + 0*NUM_X] = 1,
    [9 + 1*NUM_X] = 1,
    [13 + 2*NUM_X] = 1,
    [15 + 2*NUM_X] = 1,

    [7 + 21*NUM_X] = 1,
    [11 + 20*NUM_X] = 1,
    [13 + 19*NUM_X] = 1,
    [15 + 19*NUM_X] = 1,
    [18 + 18*NUM_X] = 1,

    [(NUM_X-1) + (NUM_Y-1)*NUM_X] = 0, // Specify last element to grow array to correct size.
};


void fx_hextiles_render(float time) {
    const float delayFactor = 10.f;
    const float baseDelay = 1;
    const float speed = 24;


    fw_image_renderBegin(&getImages()[RES_IMG_HEX_FILLED], 1);
    {
        for (int j=0; j<NUM_Y; j++) {
            for (int i=0; i<NUM_X; i++) {
                int idx = i + j*NUM_X;

                const float delay = delayFactor * _delayTable[idx]/255.f;

                int palIdx = (-baseDelay - delay + time) * speed;
                if (palIdx < 0) {
                    continue;
                }

                const int numRepeats = 2;
                if (palIdx / (_paletteLengh-1) < numRepeats) {
                    palIdx = palIdx % (_paletteLengh-1);
                }
                if (palIdx >= _maxPaletteTable[idx]) {
                    palIdx = _maxPaletteTable[idx];
                }
                if (palIdx >= _paletteLengh-1) {
                    palIdx = _paletteLengh-1;
                }

                glColor3ub(_palette[palIdx].x, _palette[palIdx].y, _palette[palIdx].z);

                // Change texture if needed.
                if (_hexStyleMap[idx]) {
                    glBindTexture(GL_TEXTURE_2D, getImages()[RES_IMG_HEX_OUTLINE].textureID);
                }

                glPushMatrix();
                glTranslatef(10 + i*16 + (j%2?8:0), 1 + j*12, 0);
                fw_image_putImage(&getImages()[RES_IMG_HEX_FILLED]);
                glPopMatrix();

                // Reset to default texture if changed before.
                if (_hexStyleMap[idx]) {
                    glBindTexture(GL_TEXTURE_2D, getImages()[RES_IMG_HEX_FILLED].textureID);
                }

            }
        }
    }
    fw_image_renderEnd();

}
